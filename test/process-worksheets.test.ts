import assert from "assert";
import { processWorksheetCode } from "../src/build-scripts/preprocess-worksheets";

suite("process worksheets", () => {
  test("process statement", async () => {
    const code = `for col from 0 to 39 step 1
  for row from 0 to 29 step 1
    let cell be if random() > 0.5 then black else white
    call grid.put(col, row, cell)
  end for
end for`;

    let actual = await processWorksheetCode(code);

    const expected =
      '<el-statement class="none multiline" id=\'for4\' tabindex="-1" >\n<el-top><el-expand>+</el-expand><el-kw>for </el-kw><el-field id="ident6" class="ok" tabindex="-1"><el-txt><el-id>col</el-id></el-txt><el-place><i>counterName</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#IdentifierField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> from </el-kw><el-field id="expr7" class="ok" tabindex="-1"><el-txt><el-lit>0</el-lit></el-txt><el-place><i>firstValue</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> to </el-kw><el-field id="expr8" class="ok" tabindex="-1"><el-txt><el-lit>39</el-lit></el-txt><el-place><i>lastValue</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> step </el-kw><el-field id="expr9" class="ok" tabindex="-1"><el-txt><el-lit>1</el-lit></el-txt><el-place><i>stepValue</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-msg></el-msg><el-fr>0</el-fr></el-top>\n<el-statement class="none multiline" id=\'for10\' tabindex="-1" >\n<el-top><el-expand>+</el-expand><el-kw>for </el-kw><el-field id="ident12" class="ok" tabindex="-1"><el-txt><el-id>row</el-id></el-txt><el-place><i>counterName</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#IdentifierField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> from </el-kw><el-field id="expr13" class="ok" tabindex="-1"><el-txt><el-lit>0</el-lit></el-txt><el-place><i>firstValue</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> to </el-kw><el-field id="expr14" class="ok" tabindex="-1"><el-txt><el-lit>29</el-lit></el-txt><el-place><i>lastValue</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> step </el-kw><el-field id="expr15" class="ok" tabindex="-1"><el-txt><el-lit>1</el-lit></el-txt><el-place><i>stepValue</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-msg></el-msg><el-fr>1</el-fr></el-top>\n<el-statement class="none" id=\'let16\' tabindex="-1" ><el-kw>let </el-kw><el-field id="var17" class="ok" tabindex="-1"><el-txt><el-id>cell</el-id></el-txt><el-place><i>name</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ValueDefField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> be </el-kw><el-field id="expr18" class="ok" tabindex="-1"><el-txt><el-kw>if </el-kw><el-method>random</el-method>() > <el-lit><el-lit>0</el-lit>.5</el-lit><el-kw> then </el-kw><el-id>black</el-id><el-kw><br>else </el-kw><el-id>white</el-id></el-txt><el-place><i>value or expression</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-msg></el-msg><el-fr>2</el-fr></el-statement>\n<el-statement class="none" id=\'call19\' tabindex="-1" ><el-top><el-kw>call </el-kw><el-field id="ident20" class="selected focused ok" tabindex="-1"><el-txt><input spellcheck="false" data-cursorstart="0" data-cursorend="0" size="7" style="width: 8ch" value="grid.put" tabindex="-1"></el-txt><el-place><i>procedureName</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ProcRefField" target="help-iframe" tabindex="-1">?</a></el-help></el-field>(<el-field id="args21" class="optional ok" tabindex="-1"><el-txt><el-id>col</el-id>, <el-id>row</el-id>, <el-id>cell</el-id></el-txt><el-place><i>arguments</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ArgListField" target="help-iframe" tabindex="-1">?</a></el-help></el-field>)<el-msg></el-msg><el-fr>3</el-fr></el-top></el-statement>\n<el-statement class="ok empty" id=\'select11\' tabindex="-1" ><el-select><el-txt></el-txt><el-place>new code</el-place><div class="options"> call each for if let print repeat set throw try variable while #</div></el-select></el-statement>\n<el-kw>end for</el-kw>\n</el-statement>\n<el-statement class="ok empty" id=\'select5\' tabindex="-1" ><el-select><el-txt></el-txt><el-place>new code</el-place><div class="options"> call each for if let print repeat set throw try variable while #</div></el-select></el-statement>\n<el-kw>end for</el-kw>\n</el-statement>';

    assert.strictEqual(actual, expected);
  });

  test("process constructor", async () => {
    const code = `constructor()
  set property.p1 to 1
end constructor`;

    let actual = await processWorksheetCode(code);

    const expected =
      '<el-constructor class="none multiline" id=\'constructor6\' tabindex="-1" >\n<el-top><el-expand>+</el-expand><el-kw>constructor</el-kw>(<el-field id="params8" class="empty optional ok" tabindex="-1"><el-txt></el-txt><el-place><i>parameter definitions</i></el-place><el-compl><i>parameter definitions</i></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ParamListField" target="help-iframe" tabindex="-1">?</a></el-help></el-field>)<el-msg></el-msg><el-fr>0</el-fr></el-top>\n<el-statement class="none" id=\'set9\' tabindex="-1" ><el-kw>set </el-kw><el-field id="ident10" class="selected focused ok" tabindex="-1"><el-txt><input spellcheck="false" data-cursorstart="0" data-cursorend="0" size="10" style="width: 11ch" value="property.p1" tabindex="-1"></el-txt><el-place><i>variableName</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#AssignableField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-kw> to </el-kw><el-field id="expr11" class="ok" tabindex="-1"><el-txt><el-lit>1</el-lit></el-txt><el-place><i>value or expression</i></el-place><el-compl></el-compl><el-msg></el-msg><el-help title="Click to open Help for this field"><a href="documentation/LangRef.html#ExpressionField" target="help-iframe" tabindex="-1">?</a></el-help></el-field><el-msg></el-msg><el-fr>1</el-fr></el-statement>\n<el-statement class="ok empty" id=\'select7\' tabindex="-1" ><el-select><el-txt></el-txt><el-place>new code</el-place><div class="options"> each for if let repeat set throw try variable while #</div></el-select></el-statement>\n<el-kw>end constructor</el-kw>\n</el-constructor>';

    assert.strictEqual(actual, expected);
  });
});
